@page "/organizzazioni/{id:int}"
@namespace Accredia.SIGAD.Web.Components.Pages.Dettagli.Organizzazioni
@using Accredia.SIGAD.Web.Components.Shared
@using Accredia.SIGAD.Web.Models.Anagrafiche

<MudContainer MaxWidth="MaxWidth.False">
    <PageHeader Title="@(_detail?.Denominazione ?? "Dettaglio organizzazione")"
                Subtitle="@($"Scheda organizzazione #{Id}")"
                BreadcrumbItems="@_breadcrumbs"
                BackLabel="@_backLabel"
                BackHref="@_backHref" />

    @if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Class="mb-4">
            @_errorMessage
        </MudAlert>
    }

    @if (_isLoading)
    {
        <MudPaper Class="pa-6 sigad-card d-flex align-center justify-center" Style="min-height:180px;">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
            <MudText Typo="Typo.body2" Class="ml-3">Caricamento dati organizzazione…</MudText>
        </MudPaper>
    }
    else if (_detail is not null)
    {
        @* ───── HERO CARD ───── *@
        <div class="det-hero">
            <div class="det-hero-main">
                <div class="det-hero-title-row">
                    <MudText Typo="Typo.h4" Class="det-hero-name">@_detail.Denominazione</MudText>
                    <MudChip T="string"
                             Color="@GetStatoColor(_detail.StatoAttivitaId)"
                             Variant="Variant.Filled"
                             Size="Size.Small"
                             Class="sigad-state-chip">
                        @GetStatoLabel(_detail.StatoAttivitaId)
                    </MudChip>
                    @if (_detail.DataCancellazione.HasValue)
                    {
                        <MudChip T="string" Color="Color.Error" Variant="Variant.Filled" Size="Size.Small"
                                 Class="sigad-state-chip">Cancellata</MudChip>
                    }
                </div>

                @if (!string.IsNullOrWhiteSpace(_detail.RagioneSociale)
                     && !string.Equals(_detail.RagioneSociale, _detail.Denominazione, StringComparison.OrdinalIgnoreCase))
                {
                    <MudText Typo="Typo.body2" Class="mud-text-secondary" Style="margin-top:2px;">
                        @_detail.RagioneSociale
                    </MudText>
                }

                @* ── Fiscal data ribbon ── *@
                <div class="det-fiscal-ribbon">
                    <div class="det-fiscal-item">
                        <span class="det-fiscal-label">P.IVA</span>
                        <span class="det-fiscal-value">@(_detail.PartitaIVA ?? "—")</span>
                    </div>
                    <div class="det-fiscal-sep"></div>
                    <div class="det-fiscal-item">
                        <span class="det-fiscal-label">Codice Fiscale</span>
                        <span class="det-fiscal-value">@(_detail.CodiceFiscale ?? "—")</span>
                    </div>
                    <div class="det-fiscal-sep"></div>
                    <div class="det-fiscal-item">
                        <span class="det-fiscal-label">REA / Registro Imprese</span>
                        <span class="det-fiscal-value">@(_detail.NRegistroImprese ?? "—")</span>
                    </div>
                </div>
            </div>

            <div class="det-hero-actions">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Edit"
                           Href="@($"/organizzazioni/{Id}/modifica")"
                           Class="det-hero-edit-btn">
                    Modifica
                </MudButton>
            </div>
        </div>

        @* ───── TABS ───── *@
        <MudPaper Elevation="0" Class="det-tabs-wrap">
            @* ── Toolbar: toggle orientamento ── *@
            <div class="det-tabs-toolbar">
                <MudText Typo="Typo.caption" Class="mud-text-secondary" Style="margin-right:4px;">
                    @(_verticalTabs ? "Verticale" : "Orizzontale")
                </MudText>
                <MudTooltip Text="@(_verticalTabs ? "Passa a schede orizzontali" : "Passa a schede verticali")">
                    <MudIconButton Icon="@(_verticalTabs
                                       ? Icons.Material.Outlined.TableRows
                                       : Icons.Material.Outlined.ViewColumn)"
                                   Size="Size.Small"
                                   Color="Color.Default"
                                   OnClick="@ToggleTabPosition" />
                </MudTooltip>
            </div>

            <div class="@($"det-tabs-shell{(_verticalTabs ? " det-tabs-shell-vertical" : string.Empty)}")">
                @if (_verticalTabs)
                {
                    <div class="det-side-tabbar" role="tablist" aria-label="Schede organizzazione">
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Inherit"
                                   StartIcon="@Icons.Material.Outlined.Dashboard"
                                   FullWidth="true"
                                   Class="det-side-tab-btn"
                                   Style="@GetSideTabStyle(0)"
                                   OnClick="@(() => ActivateTabAsync(0))">
                            Overview
                        </MudButton>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Inherit"
                                   StartIcon="@Icons.Material.Outlined.LocationOn"
                                   FullWidth="true"
                                   Class="det-side-tab-btn"
                                   Style="@GetSideTabStyle(1)"
                                   OnClick="@(() => ActivateTabAsync(1))">
                            @GetSediTabText()
                        </MudButton>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Inherit"
                                   StartIcon="@Icons.Material.Outlined.AccountTree"
                                   FullWidth="true"
                                   Class="det-side-tab-btn"
                                   Style="@GetSideTabStyle(2)"
                                   OnClick="@(() => ActivateTabAsync(2))">
                            @GetUnitaTabText()
                        </MudButton>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Inherit"
                                   StartIcon="@Icons.Material.Outlined.Work"
                                   FullWidth="true"
                                   Class="det-side-tab-btn"
                                   Style="@GetSideTabStyle(3)"
                                   OnClick="@(() => ActivateTabAsync(3))">
                            @GetIncarichiTabText()
                        </MudButton>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Inherit"
                                   StartIcon="@Icons.Material.Outlined.Badge"
                                   FullWidth="true"
                                   Class="det-side-tab-btn"
                                   Style="@GetSideTabStyle(4)"
                                   OnClick="@(() => ActivateTabAsync(4))">
                            Identificativi IVA/CF
                        </MudButton>
                    </div>
                }

                <div class="det-tabs-main">
                    <MudTabs @key="@_verticalTabs"
                             Elevation="0"
                             Rounded="false"
                             Position="Position.Top"
                             Class="@($"det-tabs{(_verticalTabs ? " det-tabs-hide-header" : string.Empty)}")"
                             data-position="Top"
                             ActivePanelIndex="@_activeTabIndex"
                             ActivePanelIndexChanged="@OnTabChanged"
                             ApplyEffectsToContainer="true"
                             PanelClass="det-tab-panel"
                             KeepPanelsAlive="true">

                @* ── OVERVIEW ── *@
                <MudTabPanel Text="Overview" Icon="@Icons.Material.Outlined.Dashboard">
                    <MudGrid Spacing="3">
                        @* — Anagrafica — *@
                        <MudItem xs="12" md="6">
                            <div class="det-section-card">
                                <div class="det-section-header">
                                    <MudIcon Icon="@Icons.Material.Outlined.Business" Size="Size.Small" Class="det-section-icon" />
                                    <MudText Typo="Typo.subtitle1" Class="det-section-title">Anagrafica</MudText>
                                </div>
                                <dl class="det-dl">
                                    <dt>Denominazione</dt>
                                    <dd>@_detail.Denominazione</dd>
                                    <dt>Ragione sociale</dt>
                                    <dd>@(_detail.RagioneSociale ?? "—")</dd>
                                    <dt>Natura giuridica</dt>
                                    <dd>@(!string.IsNullOrWhiteSpace(_detail.NaturaGiuridicaDescrizione) ? _detail.NaturaGiuridicaDescrizione : "Non disponibile")</dd>
                                </dl>
                                @if (!string.IsNullOrWhiteSpace(_detail.OggettoSociale))
                                {
                                    <div class="det-section-divider"></div>
                                    <div class="det-subsection">
                                        <span class="det-dl dt">Oggetto sociale</span>
                                        <p class="det-oggetto-sociale">@_detail.OggettoSociale</p>
                                    </div>
                                }
                            </div>
                        </MudItem>

                        @* — Dati e stato — *@
                        <MudItem xs="12" md="6">
                            <MudStack Spacing="3">
                                <div class="det-section-card">
                                    <div class="det-section-header">
                                        <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Small" Class="det-section-icon" />
                                        <MudText Typo="Typo.subtitle1" Class="det-section-title">Dati e stato</MudText>
                                    </div>
                                    <dl class="det-dl">
                                        <dt>Stato attività</dt>
                                        <dd>
                                            <MudChip T="string" Color="@GetStatoColor(_detail.StatoAttivitaId)"
                                                     Variant="Variant.Filled" Size="Size.Small" Class="sigad-state-chip">
                                                @GetStatoLabel(_detail.StatoAttivitaId)
                                            </MudChip>
                                        </dd>
                                        <dt>Data costituzione</dt>
                                        <dd>@FormatDate(_detail.DataCostituzione)</dd>
                                        <dt>Data iscrizione R.I.</dt>
                                        <dd>@FormatDate(_detail.DataIscrizioneIscrizioneRI)</dd>
                                        <dt>Data cancellazione</dt>
                                        <dd>@FormatDate(_detail.DataCancellazione)</dd>
                                    </dl>
                                </div>

                                @* — Tipologie (card separata) — *@
                                <div class="det-section-card">
                                    <div class="det-section-header">
                                        <MudIcon Icon="@Icons.Material.Outlined.Label" Size="Size.Small" Class="det-section-icon" />
                                        <MudText Typo="Typo.subtitle1" Class="det-section-title">Tipologie</MudText>
                                    </div>
                                    @if (_tipologie is { Count: > 0 })
                                    {
                                        <div class="det-chip-list">
                                            @foreach (var t in _tipologie)
                                            {
                                                <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">@t.Descrizione</MudChip>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Nessuna tipologia assegnata.</MudText>
                                    }
                                </div>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                @* ── SEDI ── *@
                <MudTabPanel Text="@GetSediTabText()" Icon="@Icons.Material.Outlined.LocationOn">
                    <div class="d-flex align-center mb-2">
                        <MudText Typo="Typo.h6">Sedi</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   Disabled="@_sediLoading"
                                   OnClick="ReloadSediAsync"
                                   Class="mr-2">
                            Ricarica
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.RestartAlt"
                                   OnClick="ResetSediView"
                                   Class="mr-2">
                            Reset vista
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Href="@($"/organizzazioni/{Id}/sedi/nuova")">
                            Nuova sede
                        </MudButton>
                    </div>
                    <MudTextField T="string"
                                  Label="Cerca sedi"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  @bind-Value="_sediSearch"
                                  Immediate="true"
                                  Class="mb-3" />

                    @if (_sediLoading)
                    {
                        <MudPaper Elevation="0" Class="pa-4 sigad-card">
                            <MudSkeleton Width="40%" Height="18px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="52px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="52px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="52px" Class="mb-2" />
                        </MudPaper>
                    }
                    else if (!string.IsNullOrWhiteSpace(_sediError))
                    {
                        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Warning">
                            @_sediError
                            <MudDivider Class="my-2" />
                            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ReloadSediAsync">
                                Riprova
                            </MudButton>
                        </MudAlert>
                    }
                    else if (_sedi.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Info">
                            Nessuna sede disponibile per questa organizzazione.
                        </MudAlert>
                    }
                    else
                    {
                        <MudPaper Elevation="0" Class="sigad-table-wrap">
                            <MudTable @key="_sediTableVersion"
                                      Items="_sedi"
                                      Filter="FilterSede"
                                      Dense="true"
                                      Hover="true"
                                      Elevation="0"
                                      @bind-CurrentPage="_sediCurrentPage"
                                      @bind-RowsPerPage="_sediRowsPerPage">
                                <HeaderContent>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<SedeItem, object?>(x => x.Denominazione ?? string.Empty))">Sede</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<SedeItem, object?>(x => FormatSedeAddress(x)))">Indirizzo</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<SedeItem, object?>(x => x.StatoSede ?? string.Empty))">Stato</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<SedeItem, object?>(x => x.DataApertura ?? DateTime.MinValue))">Apertura</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<SedeItem, object?>(x => x.DataCessazione ?? DateTime.MaxValue))">Cessazione</MudTableSortLabel></MudTh>
                                    <MudTh Align="Right"></MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Sede">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body2">
                                                @(!string.IsNullOrWhiteSpace(context.Denominazione) ? context.Denominazione : $"Sede #{context.SedeId}")
                                            </MudText>
                                            <MudStack Direction="Row" Spacing="1" Class="mt-1">
                                                @if (context.IsSedePrincipale)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">
                                                        Principale
                                                    </MudChip>
                                                }
                                                @if (context.IsSedeOperativa)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info">
                                                        Operativa
                                                    </MudChip>
                                                }
                                            </MudStack>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Indirizzo">@FormatSedeAddress(context)</MudTd>
                                    <MudTd DataLabel="Stato">
                                        <MudChip T="string"
                                                 Size="Size.Small"
                                                 Variant="Variant.Outlined"
                                                 Color="@GetSedeStatoColor(context.StatoSede)">
                                            @(!string.IsNullOrWhiteSpace(context.StatoSede) ? context.StatoSede : "N/D")
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Apertura">@FormatDate(context.DataApertura)</MudTd>
                                    <MudTd DataLabel="Cessazione">@FormatDate(context.DataCessazione)</MudTd>
                                    <MudTd Align="Right" Style="width:1%;white-space:nowrap;">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                       Color="Color.Default"
                                                       Size="Size.Small"
                                                       Href="@($"/organizzazioni/{Id}/sedi/{context.SedeId}/modifica")"
                                                       Title="Modifica sede" />
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudText Typo="Typo.body2" Class="pa-3 mud-text-secondary">
                                        Nessuna sede trovata con il filtro corrente.
                                    </MudText>
                                </NoRecordsContent>
                                <PagerContent>
                                    <MudTablePager PageSizeOptions="_rowsPerPageOptions" />
                                </PagerContent>
                            </MudTable>
                        </MudPaper>
                    }
                </MudTabPanel>

                @* ── UNITÀ ORGANIZZATIVE ── *@
                <MudTabPanel Text="@GetUnitaTabText()" Icon="@Icons.Material.Outlined.AccountTree">
                    <div class="d-flex align-center mb-2">
                        <MudText Typo="Typo.h6">Unità organizzative</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   Disabled="@_unitaLoading"
                                   OnClick="ReloadUnitaAsync"
                                   Class="mr-2">
                            Ricarica
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.RestartAlt"
                                   OnClick="ResetUnitaView"
                                   Class="mr-2">
                            Reset vista
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Href="@($"/organizzazioni/{Id}/unita-organizzative/nuova")">
                            Nuova unità
                        </MudButton>
                    </div>
                    <MudTextField T="string"
                                  Label="Cerca unità organizzative"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  @bind-Value="_unitaSearch"
                                  Immediate="true"
                                  Class="mb-3" />

                    @if (_unitaLoading)
                    {
                        <MudPaper Elevation="0" Class="pa-4 sigad-card">
                            <MudSkeleton Width="45%" Height="18px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="52px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="52px" Class="mb-2" />
                        </MudPaper>
                    }
                    else if (!string.IsNullOrWhiteSpace(_unitaError))
                    {
                        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Warning">
                            @_unitaError
                            <MudDivider Class="my-2" />
                            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ReloadUnitaAsync">
                                Riprova
                            </MudButton>
                        </MudAlert>
                    }
                    else if (_unita.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Info">
                            Nessuna unità organizzativa disponibile per questa organizzazione.
                        </MudAlert>
                    }
                    else
                    {
                        <MudPaper Elevation="0" Class="sigad-table-wrap">
                            <MudTable @key="_unitaTableVersion"
                                      Items="_unita"
                                      Filter="FilterUnita"
                                      Dense="true"
                                      Hover="true"
                                      Elevation="0"
                                      @bind-CurrentPage="_unitaCurrentPage"
                                      @bind-RowsPerPage="_unitaRowsPerPage">
                                <HeaderContent>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<UnitaOrganizzativaItem, object?>(x => x.Nome))">Nome</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<UnitaOrganizzativaItem, object?>(x => x.Codice ?? string.Empty))">Codice</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<UnitaOrganizzativaItem, object?>(x => x.TipoUnitaOrganizzativaId))">Tipo unità</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<UnitaOrganizzativaItem, object?>(x => x.TipoSedeId ?? 0))">Tipo sede</MudTableSortLabel></MudTh>
                                    <MudTh></MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Nome">
                                        <MudStack Direction="Row" Spacing="1" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body2">@context.Nome</MudText>
                                            @if (context.Principale)
                                            {
                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">
                                                    Principale
                                                </MudChip>
                                            }
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Codice">@(!string.IsNullOrWhiteSpace(context.Codice) ? context.Codice : "—")</MudTd>
                                    <MudTd DataLabel="Tipo unità">@GetTipoUnitaLabel(context.TipoUnitaOrganizzativaId)</MudTd>
                                    <MudTd DataLabel="Tipo sede">@GetTipoSedeLabel(context.TipoSedeId)</MudTd>
                                    <MudTd Style="width:1%;white-space:nowrap;text-align:right;">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                       Color="Color.Default"
                                                       Size="Size.Small"
                                                       Href="@($"/organizzazioni/{Id}/unita-organizzative/{context.UnitaOrganizzativaId}/modifica")"
                                                       Title="Modifica unità organizzativa" />
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudText Typo="Typo.body2" Class="pa-3 mud-text-secondary">
                                        Nessuna unità trovata con il filtro corrente.
                                    </MudText>
                                </NoRecordsContent>
                                <PagerContent>
                                    <MudTablePager PageSizeOptions="_rowsPerPageOptions" />
                                </PagerContent>
                            </MudTable>
                        </MudPaper>
                    }
                </MudTabPanel>

                @* ── INCARICHI ── *@
                <MudTabPanel Text="@GetIncarichiTabText()" Icon="@Icons.Material.Outlined.Work">
                    <div class="d-flex align-center mb-2">
                        <MudText Typo="Typo.h6">Incarichi</MudText>
                        <MudSpacer />
                        <MudCheckBox T="bool"
                                     Label="Includi cessati/cancellati"
                                     Value="_incarichiIncludeDeleted"
                                     ValueChanged="OnIncarichiIncludeDeletedChanged"
                                     Dense="true"
                                     Class="mr-2" />
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   Disabled="@_incarichiLoading"
                                   OnClick="ReloadIncarichiAsync"
                                   Class="mr-2">
                            Ricarica
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.RestartAlt"
                                   OnClick="ResetIncarichiView"
                                   Class="mr-2">
                            Reset vista
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Href="@($"/incarichi/nuovo?organizzazioneId={Id}")">
                            Nuovo incarico
                        </MudButton>
                    </div>
                    <MudTextField T="string"
                                  Label="Cerca incarichi"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  @bind-Value="_incarichiSearch"
                                  Immediate="true"
                                  Class="mb-3" />

                    @if (_incarichiLoading)
                    {
                        <MudPaper Elevation="0" Class="pa-4 sigad-card">
                            <MudSkeleton Width="35%" Height="18px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="52px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="52px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="52px" Class="mb-2" />
                        </MudPaper>
                    }
                    else if (!string.IsNullOrWhiteSpace(_incarichiError))
                    {
                        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Warning">
                            @_incarichiError
                            <MudDivider Class="my-2" />
                            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ReloadIncarichiAsync">
                                Riprova
                            </MudButton>
                        </MudAlert>
                    }
                    else if (_incarichi.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Info">
                            Nessun incarico disponibile per questa organizzazione.
                        </MudAlert>
                    }
                    else
                    {
                        <MudPaper Elevation="0" Class="sigad-table-wrap">
                            <MudTable @key="_incarichiTableVersion"
                                      Items="_incarichi"
                                      Filter="FilterIncarichi"
                                      Dense="true"
                                      Hover="true"
                                      Elevation="0"
                                      @bind-CurrentPage="_incarichiCurrentPage"
                                      @bind-RowsPerPage="_incarichiRowsPerPage">
                                <HeaderContent>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<IncaricoItem, object?>(x => $"{x.PersonaCognome} {x.PersonaNome}".Trim()))">Persona</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<IncaricoItem, object?>(x => x.Ruolo))">Ruolo</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<IncaricoItem, object?>(x => x.StatoIncarico))">Stato</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<IncaricoItem, object?>(x => x.DataInizio))">Inizio</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<IncaricoItem, object?>(x => x.DataFine ?? DateTime.MaxValue))">Fine</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="@(new Func<IncaricoItem, object?>(x => x.UnitaOrganizzativaId ?? 0))">UO</MudTableSortLabel></MudTh>
                                    <MudTh></MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Persona">@FormatPersona(context)</MudTd>
                                    <MudTd DataLabel="Ruolo">@DisplayOrDash(context.Ruolo)</MudTd>
                                    <MudTd DataLabel="Stato">
                                        <MudStack Direction="Row" Spacing="1" AlignItems="AlignItems.Center">
                                            <MudChip T="string"
                                                     Size="Size.Small"
                                                     Variant="Variant.Outlined"
                                                     Color="@GetIncaricoStatoColor(context.StatoIncarico)">
                                                @DisplayStatoIncarico(context.StatoIncarico)
                                            </MudChip>
                                            @if (context.DataCancellazione.HasValue)
                                            {
                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error">
                                                    Cancellato
                                                </MudChip>
                                            }
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Inizio">@FormatDate(context.DataInizio)</MudTd>
                                    <MudTd DataLabel="Fine">@FormatDate(context.DataFine)</MudTd>
                                    <MudTd DataLabel="UO">@GetUnitaLabel(context.UnitaOrganizzativaId)</MudTd>
                                    <MudTd Style="width:1%;white-space:nowrap;text-align:right;">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                       Color="Color.Default"
                                                       Size="Size.Small"
                                                       Href="@($"/incarichi/{context.IncaricoId}/modifica")"
                                                       Title="Modifica incarico" />
                                        <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                                       Color="Color.Default"
                                                       Size="Size.Small"
                                                       Href="@($"/incarichi/{context.IncaricoId}")"
                                                       Title="Apri dettaglio incarico" />
                                    </MudTd>
                                </RowTemplate>
                                <NoRecordsContent>
                                    <MudText Typo="Typo.body2" Class="pa-3 mud-text-secondary">
                                        Nessun incarico trovato con il filtro corrente.
                                    </MudText>
                                </NoRecordsContent>
                                <PagerContent>
                                    <MudTablePager PageSizeOptions="_rowsPerPageOptions" />
                                </PagerContent>
                            </MudTable>
                        </MudPaper>
                    }
                </MudTabPanel>

                @* ── IDENTIFICATIVI IVA/CF ── *@
                <MudTabPanel Text="Identificativi IVA/CF" Icon="@Icons.Material.Outlined.Badge">
                    <MudText Typo="Typo.body2" Class="mud-text-secondary pa-4">
                        Gestione identificativi in fase di sviluppo.
                    </MudText>
                </MudTabPanel>

                    </MudTabs>
                </div>
            </div>
        </MudPaper>
    }
</MudContainer>

