@using Accredia.SIGAD.Web.Models.Anagrafiche
@inject ILogger<LookupAutocomplete> Logger

<MudAutocomplete T="LookupItem"
                 Label="@Label"
                 Variant="@Variant"
                 Dense="@Dense"
                 FullWidth="@FullWidth"
                 Disabled="@Disabled"
                 Clearable="@Clearable"
                 Required="@Required"
                 RequiredError="@RequiredError"
                 Immediate="true"
                 OpenOnFocus="@OpenOnFocus"
                 Value="@Value"
                 ValueChanged="@ValueChanged"
                 ToStringFunc="@(x => x?.Label)"
                 SearchFunc="SearchAsync"
                 MinCharacters="@MinCharacters"
                 MaxItems="@MaxItems"
                 ResetValueOnEmptyText="true"
                 Strict="false" />

@code {
    [Parameter] public string Label { get; set; } = string.Empty;
    [Parameter] public Variant Variant { get; set; } = Variant.Outlined;
    [Parameter] public bool Dense { get; set; } = true;
    [Parameter] public bool FullWidth { get; set; } = true;

    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool Clearable { get; set; } = true;

    [Parameter] public bool Required { get; set; }
    [Parameter] public string? RequiredError { get; set; }

    [Parameter] public LookupItem? Value { get; set; }
    [Parameter] public EventCallback<LookupItem?> ValueChanged { get; set; }

    [Parameter] public IReadOnlyList<LookupItem> Items { get; set; } = Array.Empty<LookupItem>();
    [Parameter] public int MinCharacters { get; set; } = 0;
    [Parameter] public int? MaxItems { get; set; } = 50;
    [Parameter] public bool OpenOnFocus { get; set; } = true;
    [Parameter] public bool EnableDiagnostics { get; set; }

    private Task<IEnumerable<LookupItem>> SearchAsync(string value, CancellationToken cancellationToken)
    {
        var started = EnableDiagnostics ? System.Diagnostics.Stopwatch.StartNew() : null;
        IEnumerable<LookupItem> query = Items;

        if (!string.IsNullOrWhiteSpace(value))
        {
            var trimmed = value.Trim();
            query = query.Where(x => x.Label.Contains(trimmed, StringComparison.OrdinalIgnoreCase));
        }

        if (MaxItems.HasValue)
        {
            query = query.Take(MaxItems.Value);
        }

        if (started is not null)
        {
            started.Stop();
            var count = query is ICollection<LookupItem> c ? c.Count : query.Count();
            Logger.LogInformation("LookupAutocomplete '{Label}' search in {Elapsed} ms (items: {Items}, result: {Result}).",
                Label,
                started.ElapsedMilliseconds,
                Items.Count,
                count);
        }

        return Task.FromResult(query);
    }
}
